<Window x:Class="StarResonanceDpsAnalysis.WPF.Views.SkillLogView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:StarResonanceDpsAnalysis.WPF.ViewModels"
        xmlns:models="clr-namespace:StarResonanceDpsAnalysis.WPF.Models"
        xmlns:converters="clr-namespace:StarResonanceDpsAnalysis.WPF.Converters"
        xmlns:lex="http://wpflocalizeextension.codeplex.com"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance vm:SkillLogViewModel}"
        Title="{lex:Loc SkillLog_Title}" Height="600" Width="450"
        Style="{StaticResource TransparentWindow}"
        ResizeMode="CanResizeWithGrip">

    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        
        <!-- White Theme Colors -->
        <Color x:Key="SciFiBgColor">#FFFFFF</Color>
        <SolidColorBrush x:Key="SciFiBgBrush" Color="{StaticResource SciFiBgColor}"/>
        <SolidColorBrush x:Key="SciFiCardBrush" Color="#F5F5F5"/>
        <SolidColorBrush x:Key="SciFiBorderBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="SciFiAccentBrush" Color="#FF9F0A"/>
        <SolidColorBrush x:Key="SciFiTextMainBrush" Color="#333333"/>
        <SolidColorBrush x:Key="SciFiTextSubBrush" Color="#666666"/>
        
        <!-- ScrollBar Style -->
        <Style x:Key="SciFiScrollBar" TargetType="{x:Type ScrollBar}">
            <Setter Property="Stylus.IsPressAndHoldEnabled" Value="false"/>
            <Setter Property="Stylus.IsFlicksEnabled" Value="false"/>
            <Setter Property="Width" Value="6"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ScrollBar}">
                        <Grid x:Name="Bg" SnapsToDevicePixels="true" Background="Transparent">
                            <Track x:Name="PART_Track" IsDirectionReversed="true">
                                <Track.Thumb>
                                    <Thumb Style="{DynamicResource SciFiScrollBarThumbStyle}"/>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="SciFiScrollBarThumbStyle" TargetType="{x:Type Thumb}">
            <Setter Property="OverridesDefaultStyle" Value="true"/>
            <Setter Property="IsTabStop" Value="false"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Thumb}">
                        <Border x:Name="rectangle" CornerRadius="3" Background="#BBBBBB" Height="{TemplateBinding Height}" SnapsToDevicePixels="True"/>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="true">
                                <Setter TargetName="rectangle" Property="Background" Value="#999999"/>
                            </Trigger>
                            <Trigger Property="IsDragging" Value="true">
                                <Setter TargetName="rectangle" Property="Background" Value="#777777"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <!-- Main Container -->
    <Border Background="{StaticResource SciFiBgBrush}" 
            BorderBrush="{StaticResource SciFiBorderBrush}" 
            BorderThickness="1" 
            CornerRadius="4" 
            Margin="5">
        <Border.Effect>
            <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.2" Color="#AAAAAA"/>
        </Border.Effect>
        
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <Border Grid.Row="0" Padding="20,15" MouseDown="Header_MouseDown" Background="Transparent">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Title Area -->
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <Border Background="{StaticResource SciFiAccentBrush}" Width="4" Height="16" CornerRadius="2" Margin="0,0,10,0"/>
                        <TextBlock Text="{lex:Loc SkillLog_Header_Title}" Foreground="{StaticResource SciFiTextMainBrush}" FontWeight="Bold" FontSize="16" FontFamily="Microsoft YaHei UI"/>
                        <TextBlock Text="{lex:Loc SkillLog_Header_Status}" Foreground="{StaticResource SciFiTextSubBrush}" FontSize="10" VerticalAlignment="Bottom" Margin="8,0,0,2" FontFamily="Consolas"/>
                    </StackPanel>

                    <!-- Top Right Decoration -->
                    <TextBlock Grid.Column="1" Text="{lex:Loc SkillLog_Header_Status}" Foreground="#BBBBBB" FontSize="9" VerticalAlignment="Center" FontFamily="Consolas"/>
                </Grid>
            </Border>

            <!-- Log List -->
            <ListBox x:Name="LogListBox" Grid.Row="1" ItemsSource="{Binding Logs}" 
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                     BorderThickness="0" Padding="10,0" Background="Transparent">
                <ListBox.Resources>
                    <Style TargetType="ScrollBar" BasedOn="{StaticResource SciFiScrollBar}"/>
                </ListBox.Resources>
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0,4"/>
                        <Setter Property="BorderThickness" Value="0"/>
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <Border x:Name="ItemBorder" Background="{StaticResource SciFiCardBrush}" CornerRadius="4" SnapsToDevicePixels="true">
                                        <ContentPresenter/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="ItemBorder" Property="Background" Value="#EEEEEE"/>
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="ItemBorder" Property="Background" Value="#E8E8E8"/>
                                            <Setter TargetName="ItemBorder" Property="BorderBrush" Value="{StaticResource SciFiAccentBrush}"/>
                                            <Setter TargetName="ItemBorder" Property="BorderThickness" Value="1"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="{x:Type models:SkillLogItem}">
                        <Grid Height="50" Cursor="Hand" MouseLeftButtonUp="SkillLogItem_MouseLeftButtonUp" Tag="{Binding}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="4"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Detail Popup -->
                            <Popup x:Name="DetailPopup" 
                                   StaysOpen="False"
                                   Placement="Mouse"
                                   AllowsTransparency="True"
                                   PopupAnimation="Fade">
                                <Popup.Resources>
                                    <Style TargetType="Popup">
                                        <EventSetter Event="LostFocus" Handler="Popup_LostFocus"/>
                                    </Style>
                                </Popup.Resources>
                                <Border Background="White" 
                                        BorderBrush="{StaticResource SciFiBorderBrush}" 
                                        BorderThickness="1" 
                                        CornerRadius="4"
                                        Padding="15"
                                        MouseLeave="PopupBorder_MouseLeave">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.3" Color="#000000"/>
                                    </Border.Effect>
                                    <StackPanel>
                                        <TextBlock Text="{Binding SkillName}" 
                                                   FontWeight="Bold" 
                                                   FontSize="14" 
                                                   Foreground="{StaticResource SciFiTextMainBrush}"
                                                   Margin="0,0,0,8"/>
                                        <Separator Margin="0,0,0,8" Background="{StaticResource SciFiBorderBrush}"/>
                                        
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                            <TextBlock Text="{lex:Loc SkillLog_Popup_TotalDamage}" Foreground="{StaticResource SciFiTextSubBrush}" Width="90"/>
                                            <TextBlock Text="{Binding TotalValue, StringFormat=N0}" 
                                                       Foreground="{StaticResource SciFiTextMainBrush}" 
                                                       FontWeight="SemiBold"/>
                                        </StackPanel>
                                        
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                            <TextBlock Text="{lex:Loc SkillLog_Popup_HitCount}" Foreground="{StaticResource SciFiTextSubBrush}" Width="90"/>
                                            <TextBlock Text="{Binding Count}" 
                                                       Foreground="{StaticResource SciFiTextMainBrush}" 
                                                       FontWeight="SemiBold"/>
                                        </StackPanel>
                                        
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                            <TextBlock Text="{lex:Loc SkillLog_Popup_AvgDamage}" Foreground="{StaticResource SciFiTextSubBrush}" Width="90"/>
                                            <TextBlock Foreground="{StaticResource SciFiTextMainBrush}" FontWeight="SemiBold">
                                                <TextBlock.Text>
                                                    <MultiBinding StringFormat="{}{0:N0}">
                                                        <Binding Path="TotalValue"/>
                                                        <Binding Path="Count"/>
                                                        <MultiBinding.Converter>
                                                            <converters:DivisionMultiValueConverter/>
                                                        </MultiBinding.Converter>
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </StackPanel>
                                        
                                        <!-- Critical Count and Damage -->
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4"
                                                    Visibility="{Binding HasCrit, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="{lex:Loc SkillLog_Popup_Critical}" Foreground="{StaticResource SciFiTextSubBrush}" Width="90"/>
                                            <TextBlock Foreground="{StaticResource SciFiAccentBrush}" FontWeight="SemiBold">
                                                <TextBlock.Text>
                                                    <MultiBinding StringFormat="{}{0} ({1:F1}%)">
                                                        <Binding Path="CritCount"/>
                                                        <Binding Path="CritRate"/>
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </StackPanel>
                                        
                                        <!-- Critical Damage -->
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4"
                                                    Visibility="{Binding HasCrit, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="{lex:Loc SkillLog_Popup_CritDamage}" Foreground="{StaticResource SciFiTextSubBrush}" Width="90"/>
                                            <TextBlock Text="{Binding CritDamage, StringFormat=N0}" 
                                                       Foreground="{StaticResource SciFiAccentBrush}" 
                                                       FontWeight="SemiBold"/>
                                        </StackPanel>
                                        
                                        <!-- Lucky Hit Count -->
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4"
                                                    Visibility="{Binding HasLucky, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="{lex:Loc SkillLog_Popup_LuckyHit}" Foreground="{StaticResource SciFiTextSubBrush}" Width="90"/>
                                            <TextBlock Foreground="#9F55FF" FontWeight="SemiBold">
                                                <TextBlock.Text>
                                                    <MultiBinding StringFormat="{}{0} ({1:F1}%)">
                                                        <Binding Path="LuckyCount"/>
                                                        <Binding Path="LuckyRate"/>
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </StackPanel>
                                        
                                        <!-- Lucky Damage -->
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4"
                                                    Visibility="{Binding HasLucky, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="{lex:Loc SkillLog_Popup_LuckyDamage}" Foreground="{StaticResource SciFiTextSubBrush}" Width="90"/>
                                            <TextBlock Text="{Binding LuckyDamage, StringFormat=N0}" 
                                                       Foreground="#9F55FF" 
                                                       FontWeight="SemiBold"/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </Popup>

                            <!-- Left Strip -->
                            <Border Grid.Column="0" Background="#DDDDDD" CornerRadius="4,0,0,4"/>

                            <!-- Time -->
                            <Border Grid.Column="1" Width="40" Margin="10,0,0,0" VerticalAlignment="Center">
                                <TextBlock Text="{Binding Timestamp, StringFormat=mm:ss}" 
                                           Foreground="{StaticResource SciFiTextSubBrush}" 
                                           FontSize="11" FontFamily="Consolas"
                                           HorizontalAlignment="Center"/>
                            </Border>

                            <!-- Skill Name & Tags -->
                            <StackPanel Grid.Column="2" VerticalAlignment="Center" Margin="15,0">
                                <TextBlock Text="{Binding SkillName}" Foreground="{StaticResource SciFiTextMainBrush}" 
                                           FontWeight="SemiBold" FontSize="14" FontFamily="Microsoft YaHei UI"/>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                    <!-- Crit Tag -->
                                    <Border Background="#FFEDD5" CornerRadius="2" Padding="4,1" Margin="0,0,5,0"
                                            Visibility="{Binding HasCrit, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <TextBlock Text="{lex:Loc Common_HitType_Critical}" Foreground="{StaticResource SciFiAccentBrush}" FontSize="9" FontWeight="Bold"/>
                                    </Border>
                                    <!-- Lucky Tag -->
                                    <Border Background="#F3E8FF" CornerRadius="2" Padding="4,1" Margin="0,0,5,0"
                                            Visibility="{Binding HasLucky, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <TextBlock Text="{lex:Loc Common_HitType_Lucky}" Foreground="#9F55FF" FontSize="9" FontWeight="Bold"/>
                                    </Border>
                                    <!-- Count Tag -->
                                    <TextBlock Text="{Binding Count, StringFormat='{}x{0}'}" Foreground="{StaticResource SciFiTextSubBrush}" FontSize="10"
                                               Visibility="{Binding IsMultiHit, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- Value -->
                            <StackPanel Grid.Column="3" VerticalAlignment="Center" Margin="0,0,15,0" HorizontalAlignment="Right">
                                <TextBlock Text="{Binding TotalValue, StringFormat=N0}" 
                                           FontSize="18" FontWeight="Bold" FontFamily="Consolas"
                                           HorizontalAlignment="Right">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock" BasedOn="{StaticResource NormalTextBlockBaseStyle}">
                                            <Setter Property="Foreground" Value="{StaticResource SciFiTextMainBrush}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsHeal}" Value="True">
                                                    <Setter Property="Foreground" Value="#52C41A"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding HasCrit}" Value="True">
                                                    <Setter Property="Foreground" Value="{StaticResource SciFiAccentBrush}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <TextBlock Foreground="{StaticResource SciFiTextSubBrush}" FontSize="9" HorizontalAlignment="Right">
                                     <TextBlock.Style>
                                        <Style TargetType="TextBlock" BasedOn="{StaticResource NormalTextBlockBaseStyle}">
                                            <Setter Property="Text" Value="{lex:Loc SkillLog_Label_Damage}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsHeal}" Value="True">
                                                    <Setter Property="Text" Value="{lex:Loc SkillLog_Label_Heal}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                     </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <!-- Footer -->
            <Border Grid.Row="2" Padding="15" Background="#FAFAFA" BorderBrush="{StaticResource SciFiBorderBrush}" BorderThickness="0,1,0,0" CornerRadius="0,0,4,4">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Status Text -->
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock Text="{lex:Loc SkillLog_Footer_Connection}" Foreground="#BBBBBB" FontSize="10" FontFamily="Consolas"/>
                        <TextBlock Text="{lex:Loc SkillLog_Footer_Logging}" Foreground="#D0D0D0" FontSize="10" FontFamily="Consolas" Margin="0,2,0,0"/>
                    </StackPanel>
                    
                    <!-- Buttons -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <!-- Refresh/Clear Button -->
                        <Button Command="{Binding ClearCommand}" Margin="0,0,15,0" 
                                Width="36" Height="36" Background="Transparent" BorderThickness="0" Cursor="Hand"
                                ToolTip="{lex:Loc SkillLog_Button_Clear}">
                            <Grid>
                                <Ellipse Fill="#2196F3" Width="36" Height="36">
                                    <Ellipse.Effect>
                                        <DropShadowEffect BlurRadius="8" ShadowDepth="0" Opacity="0.4" Color="#2196F3"/>
                                    </Ellipse.Effect>
                                </Ellipse>
                                <Path Data="M12,4V1L8,5l4,4V6c3.31,0,6,2.69,6,6c0,1.01-0.25,1.97-0.7,2.8l1.46,1.46C19.54,15.03,20,13.57,20,12c0-4.42-3.58-8-8-8z M12,18c-3.31,0-6-2.69-6-6c0-1.01,0.25-1.97,0.7-2.8L5.24,7.74C4.46,8.97,4,10.43,4,12c0,4.42,3.58,8,8,8v3l4-4l-4-4V18z" 
                                      Fill="White" Stretch="Uniform" Margin="9"/>
                            </Grid>
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Grid>
                                        <ContentPresenter/>
                                        <Border x:Name="Overlay" Background="White" Opacity="0" CornerRadius="20" IsHitTestVisible="False"/>
                                    </Grid>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="Overlay" Property="Opacity" Value="0.2"/>
                                        </Trigger>
                                        <Trigger Property="IsPressed" Value="True">
                                            <Setter TargetName="Overlay" Property="Opacity" Value="0.4"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                        
                        <!-- Close Button -->
                        <Button Command="{Binding CloseCommand}"
                                Width="36" Height="36" Background="Transparent" BorderThickness="0" Cursor="Hand"
                                ToolTip="{lex:Loc SkillLog_Button_Close}">
                            <Grid>
                                <Ellipse Fill="#F44336" Width="36" Height="36">
                                    <Ellipse.Effect>
                                        <DropShadowEffect BlurRadius="8" ShadowDepth="0" Opacity="0.4" Color="#F44336"/>
                                    </Ellipse.Effect>
                                </Ellipse>
                                <Path Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41z" 
                                      Fill="White" Stretch="Uniform" Margin="10"/>
                            </Grid>
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Grid>
                                        <ContentPresenter/>
                                        <Border x:Name="Overlay" Background="White" Opacity="0" CornerRadius="20" IsHitTestVisible="False"/>
                                    </Grid>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="Overlay" Property="Opacity" Value="0.2"/>
                                        </Trigger>
                                        <Trigger Property="IsPressed" Value="True">
                                            <Setter TargetName="Overlay" Property="Opacity" Value="0.4"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
